// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ╔═══════════════════════════════════════════════════════════════╗
// ║                         TENANTS                                ║
// ╚═══════════════════════════════════════════════════════════════╝

model Tenant {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  
  // Subscription/Plan
  plan          String    @default("free")  // free, pro, enterprise
  
  // Settings
  settings      Json      @default("{}")
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  users         User[]
  apiKeys       ApiKey[]
  auditLogs     AuditLog[]
  
  @@index([slug])
}

// ╔═══════════════════════════════════════════════════════════════╗
// ║                          USERS                                 ║
// ╚═══════════════════════════════════════════════════════════════╝

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  passwordHash    String
  name            String?
  
  // Email verification
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  
  // MFA
  mfaEnabled      Boolean   @default(false)
  mfaSecret       String?
  
  // Password reset
  resetToken      String?   @unique
  resetTokenExp   DateTime?
  
  // Account status
  isActive        Boolean   @default(true)
  lastLoginAt     DateTime?
  lastLoginIp     String?
  
  // Tenant relationship
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role            UserRole  @default(MEMBER)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  apiKeys         ApiKey[]
  auditLogs       AuditLog[]
  refreshTokens   RefreshToken[]
  
  @@index([email])
  @@index([tenantId])
  @@index([resetToken])
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ╔═══════════════════════════════════════════════════════════════╗
// ║                      REFRESH TOKENS                            ║
// ╚═══════════════════════════════════════════════════════════════╝

model RefreshToken {
  id          String    @id @default(cuid())
  token       String    @unique
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Token metadata
  userAgent   String?
  ipAddress   String?
  
  // Expiration
  expiresAt   DateTime
  
  // Revocation
  revokedAt   DateTime?
  revokedBy   String?
  
  createdAt   DateTime  @default(now())
  
  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ╔═══════════════════════════════════════════════════════════════╗
// ║                         API KEYS                               ║
// ╚═══════════════════════════════════════════════════════════════╝

model ApiKey {
  id            String    @id @default(cuid())
  name          String
  
  // Key data (we store hash, not the actual key)
  keyPrefix     String              // First 8 chars for display: "kv_abc123..."
  keyHash       String    @unique   // SHA-256 hash of full key
  
  // Permissions
  scopes        String[]  @default(["read"])  // read, write, delete, admin
  
  // Rate limiting
  rateLimit     Int       @default(1000)  // requests per hour
  
  // Restrictions
  ipWhitelist   String[]  @default([])
  
  // Expiration
  expiresAt     DateTime?
  
  // Status
  isActive      Boolean   @default(true)
  revokedAt     DateTime?
  revokedBy     String?
  revokedReason String?
  
  // Usage tracking
  lastUsedAt    DateTime?
  lastUsedIp    String?
  usageCount    Int       @default(0)
  
  // Relationships
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdById   String?
  createdBy     User?     @relation(fields: [createdById], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  usageLogs     UsageLog[]
  
  @@index([keyHash])
  @@index([keyPrefix])
  @@index([tenantId])
  @@index([isActive])
}

// ╔═══════════════════════════════════════════════════════════════╗
// ║                        USAGE LOGS                              ║
// ╚═══════════════════════════════════════════════════════════════╝

model UsageLog {
  id          String    @id @default(cuid())
  
  apiKeyId    String
  apiKey      ApiKey    @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  
  // Request details
  endpoint    String
  method      String
  statusCode  Int
  
  // Client info
  ipAddress   String?
  userAgent   String?
  
  // Performance
  responseTime Int?     // milliseconds
  
  // Error tracking
  errorCode   String?
  errorMessage String?
  
  createdAt   DateTime  @default(now())
  
  @@index([apiKeyId])
  @@index([createdAt])
  @@index([endpoint])
}

// ╔═══════════════════════════════════════════════════════════════╗
// ║                        AUDIT LOGS                              ║
// ╚═══════════════════════════════════════════════════════════════╝

model AuditLog {
  id            String      @id @default(cuid())
  
  // Tenant context
  tenantId      String
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Actor (who performed the action)
  actorId       String?
  actor         User?       @relation(fields: [actorId], references: [id], onDelete: SetNull)
  actorType     ActorType   @default(USER)
  actorEmail    String?     // Denormalized for log retention
  
  // Action
  action        String      // e.g., "USER_LOGIN", "KEY_CREATED"
  
  // Resource (what was affected)
  resourceType  String?     // e.g., "API_KEY", "USER"
  resourceId    String?
  resourceName  String?     // Denormalized
  
  // Result
  status        AuditStatus @default(SUCCESS)
  errorMessage  String?
  
  // Request context
  ipAddress     String?
  userAgent     String?
  requestId     String?
  
  // Additional data
  metadata      Json        @default("{}")
  
  // Changes (for update operations)
  previousData  Json?
  newData       Json?
  
  createdAt     DateTime    @default(now())
  
  @@index([tenantId, createdAt])
  @@index([actorId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([status])
}

enum ActorType {
  USER
  API_KEY
  SYSTEM
  ANONYMOUS
}

enum AuditStatus {
  SUCCESS
  FAILURE
}

// ╔═══════════════════════════════════════════════════════════════╗
// ║              FUTURE: SECRETS MANAGEMENT                        ║
// ║         (Uncomment when ready to implement)                    ║
// ╚═══════════════════════════════════════════════════════════════╝

// model Project {
//   id              String        @id @default(cuid())
//   name            String
//   slug            String
//   description     String?
//   
//   tenantId        String
//   tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
//   
//   createdAt       DateTime      @default(now())
//   updatedAt       DateTime      @updatedAt
//   
//   environments    Environment[]
//   
//   @@unique([tenantId, slug])
//   @@index([tenantId])
// }

// model Environment {
//   id          String    @id @default(cuid())
//   name        String    // development, staging, production
//   slug        String
//   color       String?   @default("#6366f1")
//   order       Int       @default(0)
//   isLocked    Boolean   @default(false)
//   
//   projectId   String
//   project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
//   
//   createdAt   DateTime  @default(now())
//   updatedAt   DateTime  @updatedAt
//   
//   secrets     Secret[]
//   
//   @@unique([projectId, slug])
//   @@index([projectId])
// }

// model Secret {
//   id              String          @id @default(cuid())
//   key             String
//   keyHash         String          // For blind index searching
//   path            String          @default("/")
//   
//   currentVersion  Int             @default(1)
//   
//   description     String?
//   tags            String[]        @default([])
//   
//   environmentId   String
//   environment     Environment     @relation(fields: [environmentId], references: [id], onDelete: Cascade)
//   
//   deletedAt       DateTime?
//   
//   createdAt       DateTime        @default(now())
//   updatedAt       DateTime        @updatedAt
//   
//   versions        SecretVersion[]
//   
//   @@unique([environmentId, path, key])
//   @@index([environmentId])
//   @@index([keyHash])
//   @@index([deletedAt])
// }

// model SecretVersion {
//   id              String    @id @default(cuid())
//   version         Int
//   
//   encryptedValue  String    // AES-256-GCM encrypted
//   encryptedDek    String    // DEK encrypted by tenant KEK
//   iv              String
//   authTag         String
//   algorithm       String    @default("aes-256-gcm")
//   kekVersion      Int       @default(1)
//   
//   secretId        String
//   secret          Secret    @relation(fields: [secretId], references: [id], onDelete: Cascade)
//   
//   createdById     String?
//   
//   createdAt       DateTime  @default(now())
//   
//   @@unique([secretId, version])
//   @@index([secretId])
// }